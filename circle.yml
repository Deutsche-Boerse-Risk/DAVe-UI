machine:
  services:
    - docker

dependencies:
  pre:
    - npm install -g npm@3
    - npm install -g grunt-cli
    - npm install -g typescript
    - npm install -g codeclimate-test-reporter
  override:
    - npm install

test:
  override:
    - grunt testChrome
    - mkdir -p $CIRCLE_TEST_REPORTS/karma/
    - find . -type f -regex ".*/reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/karma/ \;
    - find . -type f -regex "\./coverage/.*lcov.info" -exec sh -c 'codeclimate-test-reporter < "{}"' \;
    - mkdir -p $CIRCLE_TEST_REPORTS/coverage/
    - mv coverage/* $CIRCLE_ARTIFACTS/coverage/
  post:
    - grunt dist

deployment:
  staging:
    branch: master
    commands:
      - ./dockerfile/create_docker.sh
      - ./deployment/kube_deploy.sh
